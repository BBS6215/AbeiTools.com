<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTML 代码转图片 · 本地导出</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#0b1220,#111827 40%,#0b1220);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{color:#fff;margin:0 0 6px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .card{background:rgba(17,24,39,.6);backdrop-filter:blur(6px);border:1px solid rgba(148,163,184,.15);border-radius:16px;overflow:hidden}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.12);color:#cbd5e1;font-size:12px}
    .card body{display:block}
    textarea{width:100%;height:420px;background:#0b1020;color:#e2e8f0;border:none;outline:none;padding:12px 12px 52px;line-height:1.5;font-size:13px;font-family:ui-monospace,Menlo,Consolas,monospace;resize:vertical}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:10px;border-top:1px solid rgba(148,163,184,.12);background:#0b1020}
    .toolbar .row{display:flex;gap:8px;align-items:center;color:#cbd5e1;font-size:12px}
    .toolbar input,.toolbar select{height:30px;border:1px solid rgba(148,163,184,.25);background:#0f172a;color:#e5e7eb;border-radius:8px;padding:0 8px}
    .toolbar button{height:32px;border:none;background:var(--accent);color:#052e12;padding:0 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .toolbar button.ghost{background:transparent;color:#cbd5e1;border:1px solid rgba(148,163,184,.25)}
    .preview-wrap{padding:12px;display:flex;justify-content:center;align-items:center;min-height:480px;background:#0b1020}
    .stage{position:relative;display:inline-block;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);background:#fff}
    .stage>.inner{padding:0;margin:0}
    .hint{color:#94a3b8;font-size:12px;padding:10px}
    .footer{display:flex;justify-content:space-between;align-items:center;color:#94a3b8;font-size:12px;padding:10px}
    .kbd{display:inline-block;padding:2px 6px;border:1px solid rgba(148,163,184,.35);border-radius:6px;background:#0f172a;color:#cbd5e1}
    .success{color:#10b981}
    .error{color:#f87171}
  </style>
  <!-- 安全：DOMPurify 用于清洗用户输入的 HTML，避免 XSS -->
  <script src="https://unpkg.com/dompurify@3.1.7/dist/purify.min.js"></script>
  <!-- 导出：html-to-image 将任意 DOM 节点转为 PNG/JPEG/SVG -->
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <!-- 可选：生成 PDF（将 PNG 嵌入 PDF） -->
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>HTML → 图片（PNG/JPEG/SVG/PDF 导出）</h1>
    <div class="sub">将你的 HTML/CSS 贴到左侧，点击“渲染预览”。右侧展示效果，可一键导出。支持自定义画布尺寸、背景色与缩放倍率。</div>
    <div class="grid">
      <!-- 编辑区 -->
      <section class="card">
        <header>
          <span>编辑区 · 支持内联 CSS 与 &lt;style&gt;</span>
          <button class="ghost" id="btnSample">插入示例</button>
        </header>
        <body>
          <textarea id="code" placeholder="在此粘贴你的 HTML 片段（不需要 &lt;html&gt; &lt;body&gt; 外壳）"></textarea>
          <div class="toolbar">
            <div class="row">
              <label>画布尺寸</label>
              <input id="w" type="number" value="800" min="64" step="1" style="width:90px"/>×
              <input id="h" type="number" value="450" min="64" step="1" style="width:90px"/>
            </div>
            <div class="row">
              <label>背景</label>
              <input id="bg" type="color" value="#ffffff"/>
            </div>
            <div class="row">
              <label>倍率</label>
              <select id="scale">
                <option value="1">1x</option>
                <option value="2" selected>2x（高清）</option>
                <option value="3">3x</option>
              </select>
            </div>
            <button id="btnRender">渲染预览</button>
          </div>
        </body>
      </section>

      <!-- 预览 & 导出区 -->
      <section class="card">
        <header>
          <span>预览区 · 可拖动边缘查看阴影</span>
          <div>
            <button class="ghost" id="btnClear">清空</button>
          </div>
        </header>
        <body>
          <div class="preview-wrap" id="previewWrap">
            <div class="stage" id="stage" style="width:800px;height:450px;background:#ffffff">
              <div class="inner" id="preview"></div>
            </div>
          </div>
          <div class="toolbar">
            <div class="row">
              <label>文件名</label>
              <input id="filename" value="export" style="width:180px"/>
            </div>
            <button id="btnPNG">导出 PNG</button>
            <button id="btnJPG">导出 JPEG</button>
            <button id="btnSVG">导出 SVG</button>
            <button id="btnPDF">导出 PDF</button>
          </div>
          <div class="footer">
            <div>
              <span class="kbd">Ctrl/⌘ + Enter</span> 渲染预览
              <span class="kbd">Ctrl/⌘ + S</span> 快速导出 PNG
            </div>
            <div id="status"></div>
          </div>
          <div class="hint">提示：
            1) 支持内联 <code>&lt;style&gt;</code> 与内联样式；2) 如需外部字体，可在代码顶部插入 <code>&lt;link href=&quot;https://fonts.googleapis.com/...&quot; rel=&quot;stylesheet&quot;&gt;</code>；
            3) 若外链图片跨域，建议先转为 Base64 或使用同源资源。</div>
        </body>
      </section>
    </div>
  </div>

<script>
(function(){
  const code = document.getElementById('code');
  const w = document.getElementById('w');
  const h = document.getElementById('h');
  const bg = document.getElementById('bg');
  const scaleSel = document.getElementById('scale');
  const stage = document.getElementById('stage');
  const preview = document.getElementById('preview');
  const statusEl = document.getElementById('status');
  const filenameEl = document.getElementById('filename');

  const setStatus = (msg, type='')=>{
    statusEl.textContent = msg || '';
    statusEl.className = type || '';
    if(msg){ setTimeout(()=>{statusEl.textContent='';statusEl.className='';}, 2200); }
  };

  function render(){
    try{
      const width = Math.max(64, parseInt(w.value||0,10)||800);
      const height = Math.max(64, parseInt(h.value||0,10)||450);
      stage.style.width = width + 'px';
      stage.style.height = height + 'px';
      stage.style.background = bg.value || '#ffffff';

      // 允许 style 与 link，但禁止 script/iframe 以保证安全
      const CLEAN_CONFIG = {
        ADD_TAGS: ['style','link'],
        ADD_ATTR: ['rel','href','as','crossorigin','integrity','type','media'],
        FORBID_TAGS: ['script','iframe','object','embed'],
        FORBID_ATTR: ['onload','onclick','onerror','style*'], // 禁止行内事件，允许普通 style（下面会重新允许）
        ALLOW_DATA_ATTR: false
      };
      // 单独允许 style 属性
      DOMPurify.removed = [];
      const safeHTML = DOMPurify.sanitize(code.value, {...CLEAN_CONFIG, ALLOWED_ATTR: false});

      preview.innerHTML = safeHTML;
      // 重新允许 style（仅在预览容器内）
      const walker = document.createTreeWalker(preview, NodeFilter.SHOW_ELEMENT);
      let node;
      while((node = walker.nextNode())){
        // 若存在 data-style 之类保留，可扩展；这里简单允许现有 style 不处理
      }
      setStatus('预览已更新', 'success');
    }catch(e){
      console.error(e); setStatus('渲染失败：'+ e.message, 'error');
    }
  }

  // 导出助手
  async function exportAs(type){
    const scale = parseInt(scaleSel.value,10) || 1;
    const name = (filenameEl.value||'export').replace(/[^\w\-]+/g,'_');
    const node = stage; // 将包含背景与内边距的一整个舞台导出

    const options = {
      cacheBust: true,
      pixelRatio: scale,
      width: node.clientWidth,
      height: node.clientHeight,
      backgroundColor: getComputedStyle(node).backgroundColor
    };

    try{
      if(type==='png'){
        const dataUrl = await htmlToImage.toPng(node, options);
        download(dataUrl, name + '.png');
      }else if(type==='jpeg'){
        const dataUrl = await htmlToImage.toJpeg(node, {...options, quality: 0.95});
        download(dataUrl, name + '.jpg');
      }else if(type==='svg'){
        const dataUrl = await htmlToImage.toSvg(node, options);
        download(dataUrl, name + '.svg');
      }else if(type==='pdf'){
        const pngUrl = await htmlToImage.toPng(node, options);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({orientation: node.clientWidth >= node.clientHeight ? 'l' : 'p', unit: 'px', format: [node.clientWidth, node.clientHeight]});
        pdf.addImage(pngUrl, 'PNG', 0, 0, node.clientWidth, node.clientHeight);
        pdf.save(name + '.pdf');
      }
      setStatus('已导出 ' + type.toUpperCase(), 'success');
    }catch(e){
      console.error(e); setStatus('导出失败：' + e.message, 'error');
    }
  }

  function download(dataUrl, filename){
    const a = document.createElement('a');
    a.href = dataUrl; a.download = filename; a.click();
  }

  // 事件绑定
  document.getElementById('btnRender').addEventListener('click', render);
  document.getElementById('btnPNG').addEventListener('click', ()=>exportAs('png'));
  document.getElementById('btnJPG').addEventListener('click', ()=>exportAs('jpeg'));
  document.getElementById('btnSVG').addEventListener('click', ()=>exportAs('svg'));
  document.getElementById('btnPDF').addEventListener('click', ()=>exportAs('pdf'));
  document.getElementById('btnClear').addEventListener('click', ()=>{ code.value=''; preview.innerHTML=''; setStatus('已清空'); });
  document.getElementById('btnSample').addEventListener('click', ()=>{
    code.value = `
<style>
  .card{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#a78bfa,#60a5fa);}
  .box{background:rgba(255,255,255,.9);border-radius:20px;padding:28px 32px;text-align:center;box-shadow:0 10px 24px rgba(0,0,0,.15);}
  .title{font:700 28px/1.2 ui-sans-serif,system-ui;letter-spacing:.5px;margin:0 0 8px;color:#0f172a}
  .sub{font:14px/1.6 ui-sans-serif,system-ui;color:#334155;margin:0}
</style>
<div class="card">
  <div class="box">
    <h2 class="title">Hello, Image!</h2>
    <p class="sub">把任意 HTML/CSS 渲染为图片并下载。</p>
  </div>
</div>`;
    render();
  });

  // 快捷键：渲染 & 快速导出
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); render(); }
    if((e.ctrlKey||e.metaKey) && (e.key==='s' || e.key==='S')){ e.preventDefault(); exportAs('png'); }
  });

  // 首次渲染示例
  document.getElementById('btnSample').click();
})();
</script>
</body>
</html>
