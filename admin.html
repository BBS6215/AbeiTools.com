<!doctype html>
<html lang="zh" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AbeiTools 管理后台</title>
  <meta name="description" content="AbeiTools AI导航站管理界面" />
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; }
    .modal { backdrop-filter: blur(8px); }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">

  <!-- 顶部导航 -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-bold text-indigo-600">AbeiTools 管理后台</h1>
          <div class="text-sm text-gray-500">工具总数: <span id="totalCount">0</span></div>
        </div>
        <div class="flex items-center gap-3">
          <button id="addToolBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
            ➕ 添加工具
          </button>
          <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            📥 导出数据
          </button>
          <a href="index.html" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-lg border hover:border-gray-300 transition">
            🏠 返回首页
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- 分类统计 -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">分类统计</h2>
      <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4"></div>
    </div>

    <!-- 工具列表 -->
    <div class="bg-white rounded-2xl border border-gray-200">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">工具管理</h2>
          <div class="flex items-center gap-4">
            <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">全部分类</option>
            </select>
            <input id="searchInput" type="search" placeholder="搜索工具名称..." 
              class="px-3 py-2 border border-gray-300 rounded-lg w-60" />
          </div>
        </div>
      </div>
      <div id="toolsList" class="divide-y divide-gray-200"></div>
    </div>
  </main>

  <!-- 添加/编辑工具模态框 -->
  <div id="toolModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
      <div class="p-6 border-b border-gray-200">
        <h3 id="modalTitle" class="text-lg font-semibold">添加工具</h3>
      </div>
      
      <form id="toolForm" class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">网站URL *</label>
            <input id="urlInput" type="url" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="https://example.com" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">分类 *</label>
            <select id="categoryInput" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="">选择分类</option>
              <option value="llm">AI 大模型</option>
              <option value="image">AI 图像</option>
              <option value="video">AI 视频</option>
              <option value="audio">AI 音频</option>
              <option value="search">AI 搜索</option>
              <option value="code">AI 编程</option>
              <option value="agent">AI 智能体</option>
              <option value="workflow">AI 工作流</option>
              <option value="office">AI 办公</option>
              <option value="other">其他</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">中文名称 *</label>
            <input id="nameZhInput" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">英文名称 *</label>
            <input id="nameEnInput" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">中文描述 *</label>
            <textarea id="descZhInput" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 h-20 resize-none"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">英文描述 *</label>
            <textarea id="descEnInput" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 h-20 resize-none"></textarea>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">图标URL (可选)</label>
          <input id="iconInput" type="url" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="https://example.com/icon.png (留空将自动获取网站favicon)" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">中文标签 (用逗号分隔)</label>
            <input id="tagsZhInput" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="标签1,标签2,标签3" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">英文标签 (用逗号分隔)</label>
            <input id="tagsEnInput" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="tag1,tag2,tag3" />
          </div>
        </div>

        <div class="flex items-center">
          <input id="sponsorInput" type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
          <label for="sponsorInput" class="ml-2 text-sm text-gray-700">赞助商</label>
        </div>
      </form>

      <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
        <button id="cancelBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
          取消
        </button>
        <button id="saveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
          保存
        </button>
      </div>
    </div>
  </div>

  <script>
    // 分类映射
    const CATEGORY_META = {
      llm:      { name: { zh: "AI 大模型", en: "AI Large Language Models" } },
      image:    { name: { zh: "AI 图像", en: "AI Image" } },
      video:    { name: { zh: "AI 视频", en: "AI Video" } },
      audio:    { name: { zh: "AI 音频", en: "AI Audio & Speech" } },
      search:   { name: { zh: "AI 搜索", en: "AI Search" } },
      code:     { name: { zh: "AI 编程", en: "AI Coding" } },
      agent:    { name: { zh: "AI 智能体", en: "AI Agents" } },
      workflow: { name: { zh: "AI 工作流", en: "AI Workflows" } },
      office:   { name: { zh: "AI 办公", en: "AI Office" } },
      other:    { name: { zh: "其他", en: "Others" } }
    };

    let toolsData = [];
    let editingId = null;

    // DOM 元素
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    // 加载数据
    function loadData() {
      // 总是从JSON文件加载最新数据，然后同步到localStorage
      fetch('./data/links.json?v=' + Date.now())
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          return r.json();
        })
        .then(data => {
          toolsData = Array.isArray(data) ? data : data.links;
          console.log('成功加载数据，工具数量:', toolsData.length);
          saveData();
          renderAll();
        })
        .catch(err => {
          console.error('从JSON文件加载数据失败:', err);
          // 如果JSON加载失败，尝试从localStorage恢复
          const savedData = localStorage.getItem('abeitools_data');
          if (savedData) {
            console.log('从localStorage恢复数据');
            toolsData = JSON.parse(savedData);
            renderAll();
          } else {
            alert('加载数据失败：' + err.message + '\n请检查服务器是否正常运行');
          }
        });
    }

    // 保存数据到localStorage
    function saveData() {
      localStorage.setItem('abeitools_data', JSON.stringify(toolsData));
    }

    // 渲染所有内容
    function renderAll() {
      renderStats();
      renderToolsList();
      renderFilters();
    }

    // 渲染分类统计
    function renderStats() {
      const stats = {};
      Object.keys(CATEGORY_META).forEach(cat => stats[cat] = 0);
      toolsData.forEach(tool => stats[tool.category] = (stats[tool.category] || 0) + 1);

      const container = $('#categoryStats');
      container.innerHTML = '';
      
      Object.entries(stats).forEach(([cat, count]) => {
        const div = document.createElement('div');
        div.className = 'text-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
          <div class="text-2xl font-bold text-indigo-600">${count}</div>
          <div class="text-sm text-gray-600">${CATEGORY_META[cat].name.zh}</div>
        `;
        container.appendChild(div);
      });

      $('#totalCount').textContent = toolsData.length;
    }

    // 渲染工具列表
    function renderToolsList() {
      const container = $('#toolsList');
      const searchTerm = $('#searchInput').value.toLowerCase();
      const categoryFilter = $('#categoryFilter').value;
      
      const filtered = toolsData.filter(tool => {
        const matchesSearch = !searchTerm || 
          tool.name.zh.toLowerCase().includes(searchTerm) || 
          tool.name.en.toLowerCase().includes(searchTerm) ||
          tool.desc.zh.toLowerCase().includes(searchTerm) ||
          tool.desc.en.toLowerCase().includes(searchTerm);
        const matchesCategory = !categoryFilter || tool.category === categoryFilter;
        return matchesSearch && matchesCategory;
      });

      container.innerHTML = '';
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500">暂无工具</div>';
        return;
      }

      filtered.forEach(tool => {
        const row = document.createElement('div');
        row.className = 'p-4 hover:bg-gray-50 transition';
        
        const iconUrl = tool.icon || `https://www.google.com/s2/favicons?domain=${new URL(tool.url).hostname}&sz=32`;
        
        row.innerHTML = `
          <div class="flex items-center gap-4">
            <img src="${iconUrl}" alt="${tool.name.zh}" class="w-10 h-10 rounded-lg flex-shrink-0" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSIxMCIgZmlsbD0iI2YxZjVmOSIvPjxwYXRoIGQ9Ik0yMCAxMGE4IDggMCAxIDAgMCAxNkE4IDggMCAwIDAgMjAgMTB6IiBmaWxsPSIjYzNkNGUzIi8+PC9zdmc+';" />
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="font-medium text-gray-900">${tool.name.zh}</h3>
                <span class="text-sm text-gray-500">(${tool.name.en})</span>
                <span class="px-2 py-1 text-xs bg-indigo-100 text-indigo-800 rounded-full">${CATEGORY_META[tool.category].name.zh}</span>
              </div>
              <p class="text-sm text-gray-600 mb-2">${tool.desc.zh}</p>
              <div class="flex items-center gap-4 text-xs text-gray-500">
                <span>🔗 ${tool.url}</span>
                <span>🏷️ ${tool.tags.zh.join(', ')}</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="editTool('${tool.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">
                ✏️
              </button>
              <button onclick="deleteTool('${tool.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                🗑️
              </button>
            </div>
          </div>
        `;
        container.appendChild(row);
      });
    }

    // 渲染筛选器
    function renderFilters() {
      const select = $('#categoryFilter');
      const currentValue = select.value;
      select.innerHTML = '<option value="">全部分类</option>';
      
      Object.entries(CATEGORY_META).forEach(([cat, meta]) => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = meta.name.zh;
        if (cat === currentValue) option.selected = true;
        select.appendChild(option);
      });
    }

    // 打开模态框
    function openModal(title, tool = null) {
      editingId = tool?.id || null;
      $('#modalTitle').textContent = title;
      
      if (tool) {
        $('#urlInput').value = tool.url;
        $('#categoryInput').value = tool.category;
        $('#nameZhInput').value = tool.name.zh;
        $('#nameEnInput').value = tool.name.en;
        $('#descZhInput').value = tool.desc.zh;
        $('#descEnInput').value = tool.desc.en;
        $('#iconInput').value = tool.icon || '';
        $('#tagsZhInput').value = tool.tags.zh.join(',');
        $('#tagsEnInput').value = tool.tags.en.join(',');
        $('#sponsorInput').checked = tool.sponsor;
      } else {
        $('#toolForm').reset();
      }
      
      $('#toolModal').classList.remove('hidden');
      $('#toolModal').classList.add('flex');
    }

    // 关闭模态框
    function closeModal() {
      $('#toolModal').classList.add('hidden');
      $('#toolModal').classList.remove('flex');
      editingId = null;
    }

    // 添加工具
    function addTool() {
      console.log('执行addTool函数');
      openModal('添加工具');
    }

    // 编辑工具
    function editTool(id) {
      console.log('执行editTool函数，ID:', id);
      const tool = toolsData.find(t => t.id === id);
      if (tool) {
        openModal('编辑工具', tool);
      }
    }

    // 删除工具
    function deleteTool(id) {
      const tool = toolsData.find(t => t.id === id);
      if (tool && confirm(`确定要删除工具 "${tool.name.zh}" 吗？`)) {
        toolsData = toolsData.filter(t => t.id !== id);
        saveData();
        renderAll();
      }
    }

    // 保存工具
    function saveTool() {
      const form = $('#toolForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const toolData = {
        id: editingId || Date.now().toString(),
        url: $('#urlInput').value,
        category: $('#categoryInput').value,
        name: {
          zh: $('#nameZhInput').value,
          en: $('#nameEnInput').value
        },
        desc: {
          zh: $('#descZhInput').value,
          en: $('#descEnInput').value
        },
        icon: $('#iconInput').value || undefined,
        tags: {
          zh: $('#tagsZhInput').value.split(',').map(t => t.trim()).filter(Boolean),
          en: $('#tagsEnInput').value.split(',').map(t => t.trim()).filter(Boolean)
        },
        sponsor: $('#sponsorInput').checked
      };

      if (editingId) {
        const index = toolsData.findIndex(t => t.id === editingId);
        if (index !== -1) {
          toolsData[index] = toolData;
        }
      } else {
        toolsData.push(toolData);
      }

      saveData();
      renderAll();
      closeModal();
    }

    // 导出数据
    function exportData() {
      console.log('执行导出数据，工具数量:', toolsData.length);
      if (!toolsData || toolsData.length === 0) {
        alert('暂无数据可导出');
        return;
      }
      
      const dataStr = JSON.stringify({ links: toolsData }, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'links.json';
      document.body.appendChild(link); // 确保链接在DOM中
      link.click();
      document.body.removeChild(link); // 清理DOM
      URL.revokeObjectURL(url);
      console.log('导出完成');
    }

    // 事件监听
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM加载完成，开始初始化...');
      loadData();

      // 确保所有按钮事件都正确绑定
      const addBtn = $('#addToolBtn');
      const exportBtn = $('#exportBtn');
      const cancelBtn = $('#cancelBtn');
      const saveBtn = $('#saveBtn');
      const searchInput = $('#searchInput');
      const categoryFilter = $('#categoryFilter');

      if (addBtn) {
        addBtn.addEventListener('click', (e) => {
          console.log('点击了添加工具按钮');
          e.preventDefault();
          addTool();
        });
      } else {
        console.error('未找到添加工具按钮');
      }

      if (exportBtn) {
        exportBtn.addEventListener('click', (e) => {
          console.log('点击了导出数据按钮');
          e.preventDefault();
          exportData();
        });
      } else {
        console.error('未找到导出数据按钮');
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', closeModal);
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', (e) => {
          console.log('点击了保存按钮');
          e.preventDefault();
          saveTool();
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', renderToolsList);
      }

      if (categoryFilter) {
        categoryFilter.addEventListener('change', renderToolsList);
      }

      // 点击模态框背景关闭
      $('#toolModal').addEventListener('click', (e) => {
        if (e.target === $('#toolModal')) {
          closeModal();
        }
      });

      // ESC键关闭模态框
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !$('#toolModal').classList.contains('hidden')) {
          closeModal();
        }
      });
    });

    // 全局函数暴露
    window.editTool = editTool;
    window.deleteTool = deleteTool;
  </script>
</body>
</html>